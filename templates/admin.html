{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Coordinator Dashboard</h2>
    <p><strong>Status:</strong> {{ "Open" if state.is_open else "Closed" }} |
       Participants: {{ counts.participants }} |
       Decisions: {{ counts.decisions }}</p>

    <form method="post" action="{{ url_for('admin_state') }}" style="display:inline-block; margin-right:8px;">
      <input type="hidden" name="key" value="{{ key }}">
      <button class="btn {% if state.is_open %}{% else %}primary{% endif %}" name="action" value="open">Open</button>
      <button class="btn {% if state.is_open %}primary{% else %}{% endif %}" name="action" value="close">Close</button>
    </form>

    <a class="btn" href="{{ url_for('admin_export', key=key) }}">Download CSV</a>

    <form method="post" action="{{ url_for('admin_reset') }}" style="display:inline-block; margin-left:8px;"
          onsubmit="return confirm('Delete all participant data?');">
      <input type="hidden" name="key" value="{{ key }}">
      <button class="btn">Reset Data</button>
    </form>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>Visualizations</h3>
    <p>Each chart uses <strong>each participantâ€™s average X</strong> (one point per person).</p>

    <div class="grid2">
      <div class="chartBox"><canvas id="hist5"></canvas></div>
      <div class="chartBox"><canvas id="hist10"></canvas></div>
    </div>
    <div class="grid2">
      <div class="chartBox"><canvas id="hist20"></canvas></div>
      <div class="chartBox"><canvas id="avgGender"></canvas></div>
    </div>
    <div class="grid2">
      <div class="chartBox"><canvas id="avgAge"></canvas></div>
      <div class="chartBox"><canvas id="avgRace"></canvas></div>
    </div>

    <h4>Names per 10-point interval (by average X)</h4>
    <table class="table" id="namesTable">
      <thead><tr><th>Interval</th><th>Names</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
{% endblock %}

{% block scripts %}
<script>
async function loadStats() {
  const url = new URL("{{ url_for('admin_stats_json') }}", window.location.origin);
  url.searchParams.set("key", "{{ key }}");
  const res = await fetch(url);
  if (!res.ok) { alert("Failed to load stats"); return; }
  const s = await res.json();

  const byBin = (arr) => ({ labels: arr.map(d => d.bin), data: arr.map(d => d.count) });

  const gridColor  = 'rgba(148,163,184,0.18)';
  const tickColor  = '#cbd5e1';
  const titleColor = '#e5e7eb';

  function makeBar(id, labels, data, chartTitle, xLabel, yLabel) {
    new Chart(document.getElementById(id), {
      type: 'bar',
      data: { labels, datasets: [{ label: chartTitle, data, borderWidth: 1 }] },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text: chartTitle, color: titleColor, font: { size: 16, weight: 'bold' } }
        },
        scales: {
          x: { title: { display: true, text: xLabel, color: titleColor, font: { weight: '600' } },
               ticks: { color: tickColor }, grid: { color: gridColor } },
          y: { beginAtZero: true,
               title: { display: true, text: yLabel, color: titleColor, font: { weight: '600' } },
               ticks: { color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
  }

  // Histograms of average X (counts of participants)
  const h5  = byBin(s.hist_5);
  const h10 = byBin(s.hist_10);
  const h20 = byBin(s.hist_20);
  makeBar('hist5',  h5.labels,  h5.data,  'Histogram of average X (bin = 5)',  'Average X (bin width = 5)',  'Number of participants');
  makeBar('hist10', h10.labels, h10.data, 'Histogram of average X (bin = 10)', 'Average X (bin width = 10)', 'Number of participants');
  makeBar('hist20', h20.labels, h20.data, 'Histogram of average X (bin = 20)', 'Average X (bin width = 20)', 'Number of participants');

  // Group averages (average of average X)
  makeBar('avgGender',
          s.avg_by_gender.map(d => d.group),
          s.avg_by_gender.map(d => d.avg_x),
          'Average of average X by gender', 'Gender', 'Average X');

  makeBar('avgAge',
          s.avg_by_age.map(d => d.group),
          s.avg_by_age.map(d => d.avg_x),
          'Average of average X by age group', 'Age group', 'Average X');

  makeBar('avgRace',
          s.avg_by_race.map(d => d.group),
          s.avg_by_race.map(d => d.avg_x),
          'Average of average X by race', 'Race', 'Average X');

  // Names table (one row per interval)
  const tbody = document.querySelector('#namesTable tbody');
  tbody.innerHTML = s.names_by_bin_10.map(d =>
    `<tr><td>${d.bin}</td><td>${d.names.join(', ')}</td></tr>`
  ).join('');
}
loadStats();
</script>
<style>
.chartBox { height: 280px; } /* breathing room for axes/titles */
</style>
{% endblock %}

