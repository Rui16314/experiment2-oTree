
{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Coordinator Dashboard</h2>
    <p><strong>Status:</strong> {{ "Open" if state.is_open else "Closed" }} | Participants: {{ counts.participants }} | Decisions: {{ counts.decisions }}</p>
    <form method="post" action="{{ url_for('admin_state') }}" style="display:inline-block; margin-right:8px;">
      <input type="hidden" name="key" value="{{ key }}">
      <button class="btn {% if state.is_open %}{% else %}primary{% endif %}" name="action" value="open">Open</button>
      <button class="btn {% if state.is_open %}primary{% else %}{% endif %}" name="action" value="close">Close</button>
    </form>
    <a class="btn" href="{{ url_for('admin_export', key=key) }}">Download CSV</a>
    <form method="post" action="{{ url_for('admin_reset') }}" style="display:inline-block; margin-left:8px;" onsubmit="return confirm('Delete all participant data?');">
      <input type="hidden" name="key" value="{{ key }}">
      <button class="btn">Reset Data</button>
    </form>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>Visualizations</h3>
    <p>These charts update as participants submit decisions.</p>
    <div class="grid2">
      <canvas id="hist5"></canvas>
      <canvas id="hist10"></canvas>
    </div>
    <div class="grid2">
      <canvas id="hist20"></canvas>
      <canvas id="avgGender"></canvas>
    </div>
    <div class="grid2">
      <canvas id="avgAge"></canvas>
      <canvas id="avgRace"></canvas>
    </div>
    <h4>Names per 10-point interval</h4>
    <pre id="namesBin" class="pre"></pre>
  </div>
{% endblock %}

{% block scripts %}
<script>
async function loadStats() {
  const url = new URL("{{ url_for('admin_stats_json') }}", window.location.origin);
  url.searchParams.set("key", "{{ key }}");
  const res = await fetch(url);
  if (!res.ok) { alert("Failed to load stats"); return; }
  const s = await res.json();

  const byBin = (arr) => ({ labels: arr.map(d => d.bin), data: arr.map(d => d.count) });

  const makeBar = (id, labels, data, title) => {
    new Chart(document.getElementById(id), {
      type: 'bar',
      data: { labels, datasets: [{ label: title, data }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  };

  const h5 = byBin(s.hist_5);   makeBar('hist5', h5.labels, h5.data, 'Counts (bin=5)');
  const h10 = byBin(s.hist_10); makeBar('hist10', h10.labels, h10.data, 'Counts (bin=10)');
  const h20 = byBin(s.hist_20); makeBar('hist20', h20.labels, h20.data, 'Counts (bin=20)');

  makeBar('avgGender', s.avg_by_gender.map(d=>d.group), s.avg_by_gender.map(d=>d.avg_x), 'Average x by gender');
  makeBar('avgAge',    s.avg_by_age.map(d=>d.group),    s.avg_by_age.map(d=>d.avg_x),    'Average x by age');
  makeBar('avgRace',   s.avg_by_race.map(d=>d.group),   s.avg_by_race.map(d=>d.avg_x),   'Average x by race');

  const names = s.names_by_bin_10.map(d => `${d.bin}: ${d.names.join(", ")}`).join("\n");
  document.getElementById('namesBin').textContent = names || "No data yet";
}
loadStats();
</script>
{% endblock %}
